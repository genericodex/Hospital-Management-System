<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

<ui:composition template="/template.xhtml">
    <ui:define name="title">Patient Management</ui:define>

    <ui:define name="content">
        <div class="bg-white rounded-lg shadow-lg p-8 max-w-6xl mx-auto mt-6">
            <h:form id="patientForm">
                <p:growl id="messages" showDetail="true" autoUpdate="true" styleClass="mb-4"/>

                <p:toolbar styleClass="bg-blue-50 rounded-lg mb-4 p-4 flex flex-wrap gap-4 items-center justify-between">
                    <p:toolbarGroup name="left">
                    <p:commandButton value="Add New" icon="pi pi-plus"
                                     action="#{patientBean.initNewPatient}"
                                     update="patientForm:patientDialog"
                                     process="@this"
                                     oncomplete="PF('patientDialog').show()"
                                     styleClass="!bg-green-600 text-white font-semibold rounded !border-green-600 shadow mr-2 text-xs "
                                     rendered="#{authBean.hasPermission('PATIENT_CREATE')}"/>

                        <span style="display:inline-block; width:0.75rem;"/>

                    </p:toolbarGroup>
                    <p:toolbarGroup name="center">
                        <div class="text-2xl font-bold text-green-700/20  " style="letter-spacing: 3rem">
                            PATIENTS
                        </div>
                    </p:toolbarGroup>

                    <p:toolbarGroup name="right">
                        <p:commandButton value="View Deleted" icon="pi pi-history"
                                         action="#{patientBean.loadDeletedPatients}"
                                         update="patientForm:deletedPatientsDialog"
                                         oncomplete="PF('deletedPatientsDialog').show()"
                                         styleClass="!bg-green-600 !border-green-600 text-white font-semibold rounded
                                         shadow text-xs "
                                         rendered="#{authBean.hasPermission('PATIENT_VIEW_DELETED')}"/>
                    </p:toolbarGroup>
                </p:toolbar>

                <!-- Search Bar -->
                <div class="mb-4 flex items-center gap-2">
                    <p:inputText value="#{patientBean.searchTerm}" placeholder="Search by name..." styleClass="w-64"/>
                    <p:commandButton value="Search" icon="pi pi-search" action="#{patientBean.searchPatients}"
                                     styleClass="!bg-green-600 !border-green-600"
                                     update="patientForm:patientTable"/>
                </div>
                <div style="overflow-x:auto;">
                    <p:dataTable id="patientTable" var="patient" value="#{patientBean.filteredPatients}"
                                 paginator="true" rows="10" selection="#{patientBean.selectedPatients}"
                                 rowKey="#{patientBean.selectedPatient.id}" emptyMessage="No patients found"
                                 style="min-width: 1500px; width:100%;"
                                 scrollable="true" scrollWidth="1500px"
                                 styleClass="divide-y divide-gray-200 text-sm rounded-lg overflow-hidden shadow"
                                 tableStyleClass="w-full"
                                 paginatorPosition="bottom" rowsPerPageTemplate="5,10,15,50,100">
                        <p:column selectionMode="multiple" style="width:3%" rendered="#{authBean.staff.role.name == 'ADMIN'|| authBean.staff.role.name == 'RECEPTIONIST' || authBean.staff.role.name == 'IT SUPPORT'}"/>

                        <p:column headerText="ID" sortBy="#{patientBean.selectedPatient.id}">
                            <h:outputText value="#{patient.id}" styleClass="font-semibold text-blue-700"/>
                        </p:column>

                        <p:column headerText="Name" sortBy="#{patient.lastName}">
                            <h:outputText value="#{patient.firstName} #{patient.lastName}" styleClass="text-gray-800"/>
                        </p:column>

                        <p:column headerText="Date of Birth" sortBy="#{patient.dateOfBirth}">
                            <h:outputText value="#{patient.dateOfBirth}">
                                <f:convertDateTime pattern="MMM dd, yyyy"/>
                            </h:outputText>
                        </p:column>

                        <p:column headerText="Email" sortBy="#{patient.email}">
                            <h:outputText value="#{patient.email}"/>
                        </p:column>

                        <p:column headerText="Phone" sortBy="#{patient.contactNumber}">
                            <h:outputText value="#{patient.contactNumber}"/>
                        </p:column>

                        <p:column headerText="Address" sortBy="#{patient.address}">
                            <h:outputText value="#{patient.address}" styleClass="text-gray-600"/>
                        </p:column>

                        <p:column headerText="History" sortBy="#{patient.medicalHistory}">
                            <h:outputText value="#{patient.medicalHistory}" styleClass="text-gray-600"/>
                        </p:column>

                        <p:column headerText="Actions" style="width:10%" rendered="#{authBean.staff.role.name == 'ADMIN' || authBean.staff.role.name == 'RECEPTIONIST' || authBean.staff.role.name == 'IT SUPPORT'}">
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <p:commandButton icon="pi pi-pencil" title="Edit"
                                                 rendered="#{authBean.hasPermission('PATIENT_EDIT')}"
                                                 action="#{patientBean.editPatient(patient)}"
                                                 update="patientForm:patientDialog"
                                                 process="@this"
                                                 oncomplete="PF('patientDialog').show()"
                                                 styleClass=" !bg-gray-300 hover:!bg-gray-400 !border-gray-300 !text-black !font-medium p-0 m-0 text-xs min-w-[28px] min-h-[28px]"/>

                                <p:commandButton icon="pi pi-trash" title="Delete"
                                                 rendered="#{authBean.hasPermission('PATIENT_DELETE_SOFT')}"
                                                 action="#{patientBean.deletePatient(patient)}"
                                                 update="patientForm:messages,patientForm:patientTable"
                                                 styleClass="!bg-red-500 border !border-red-700 p-0 m-0 text-xs min-w-[28px] min-h-[28px]">
                                    <p:confirm header="Confirmation" message="Are you sure you want to delete this patient?" icon="pi pi-exclamation-triangle"/>
                                </p:commandButton>
                            </div>
                        </p:column>
                    </p:dataTable>
                </div>

                <p:confirmDialog global="true" showEffect="fade" hideEffect="fade" styleClass="bg-white rounded-lg shadow-lg">
                    <p:commandButton value="Yes" type="button" styleClass="ui-confirmdialog-yes !bg-green-500 hover:!bg-green-600 text-white font-semibold py-2 px-4 rounded shadow"/>
                    <p:commandButton value="Cancel" type="button" styleClass="ui-confirmdialog-no !bg-gray-500 hover:!bg-red-300 text-white font-semibold py-2 px-4 rounded shadow"/>
                </p:confirmDialog>

                <!-- Add/Edit Patient Dialog -->
                <p:dialog id="patientDialog" header="Patient Details" widgetVar="patientDialog" modal="true" resizable="false" dynamic="true">
                    <h:panelGrid columns="2" cellpadding="5" style="width:100%;">
                        <h:outputLabel for="firstName" value="First Name:"/>
                        <p:inputText id="firstName" value="#{patientBean.selectedPatient.firstName}" required="true" validatorMessage="Enter a valid first name"/>

                        <h:outputLabel for="lastName" value="Last Name:"/>
                        <p:inputText id="lastName" value="#{patientBean.selectedPatient.lastName}" required="true" validatorMessage="Enter a valid last name"/>

                        <h:outputLabel for="dob" value="Date of Birth:"/>
                        <p:calendar id="dob" value="#{patientBean.selectedPatient.dateOfBirth}" pattern="yyyy-MM-dd"
                                    required="true" navigator="true" yearRange="c-100:c" maxdate="#{now}" validatorMessage="Enter a valid date of birth">
                        <f:ajax event="blur" render=":patientForm:messages"/>
                        </p:calendar>

                        <h:outputLabel for="email" value="Email:"/>
                        <p:inputText id="email" value="#{patientBean.selectedPatient.email}" required="true" validatorMessage="Enter a valid email address format"
                                     placeholder="Enter email...">
                            <f:validateRegex pattern="^.+@.+\.com$"/>
                            <f:ajax event="blur" render=":patientForm:messages"/>
                        </p:inputText>

                        <h:outputLabel for="phone" value="Phone:"/>
                        <p:inputText id="phone" value="#{patientBean.selectedPatient.contactNumber}" required="true" maxlength="10"
                                     pattern="\d{10}" title="Phone number must be exactly 10 digits." validatorMessage="Phone number must be exactly 10 digits.">
                            <f:validateRegex pattern="\d{10}" />
                            <f:ajax event="blur" render=":patientForm:messages"/>
                        </p:inputText>

                        <h:outputLabel for="address" value="Address:"/>
                        <p:inputTextarea id="address" value="#{patientBean.selectedPatient.address}" required="true"/>

                        <h:outputLabel for="medicalHistory" value="Medical History:" style="vertical-align:top;"/>
                        <p:inputTextarea id="medicalHistory" value="#{patientBean.selectedPatient.medicalHistory}" required="true"
                                         rows="5" cols="30" maxlength="500" placeholder="Enter medical history..." style="width:100%;"/>
                    </h:panelGrid>

                    <f:facet name="footer">
                        <p:commandButton value="Save" action="#{patientBean.savePatient}"
                                         update="patientForm:messages,patientForm:patientTable"
                                         styleClass="!bg-green-600 !border-green-600 !font-medium hover:!bg-green-500"
                                         oncomplete="if(!args.validationFailed) PF('patientDialog').hide()"
                                         rendered="#{authBean.staff.role.name == 'ADMIN'|| authBean.staff.role.name == 'RECEPTIONIST' || authBean.staff.role.name == 'IT SUPPORT'}"/>
                        <p:commandButton value="Cancel" onclick="PF('patientDialog').hide()"
                                         styleClass="!bg-green-200 !border-green-200  !font-medium !text-black hover:!bg-green-300"
                                         type="button"/>
                    </f:facet>
                </p:dialog>

                <!-- Deleted Patients Dialog -->
                <p:dialog id="deletedPatientsDialog" header="Deleted Patients" widgetVar="deletedPatientsDialog" modal="true"
                          resizable="false">
                    <p:dataTable var="patient" value="#{patientBean.deletedPatients}" paginator="true" rows="10">
                        <p:column headerText="ID">
                            <h:outputText value="#{patient.id}"/>
                        </p:column>

                        <p:column headerText="Name">
                            <h:outputText value="#{patient.firstName} #{patient.lastName}"/>
                        </p:column>

                        <p:column headerText="Email">
                            <h:outputText value="#{patient.email}"/>
                        </p:column>
                        <p:column headerText="Phone">
                            <h:outputText value="#{patient.contactNumber}"/>
                        </p:column>
                        <p:column headerText="Date of Birth">
                            <h:outputText value="#{patient.dateOfBirth}">
                                <f:convertDateTime pattern="MMM dd, yyyy"/>
                            </h:outputText>
                        </p:column>

                    </p:dataTable>
                </p:dialog>
            </h:form>
        </div>
    </ui:define>
</ui:composition>
</html>